# Nginx 예제: https://sse.aines.kr
# - /         → Admin Frontend (Next.js)
# - /api/     → Backend API (NestJS, 내부 포트 8080)
#
# 사용: SSL 인증서는 certbot 또는 수동으로. 이 파일을 /etc/nginx/sites-available/ 등에 두고
#       symlink 후 nginx -t && systemctl reload nginx

server {
    listen 80;
    listen [::]:80;
    server_name sse.aines.kr;
    # HTTPS로 리다이렉트 (certbot 사용 시 먼저 80으로 인증 후 443 블록 활성화)
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name sse.aines.kr;

    # SSL (실제 경로로 변경)
    ssl_certificate     /etc/letsencrypt/live/sse.aines.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sse.aines.kr/privkey.pem;

    # 로그
    access_log /var/log/nginx/sse.aines.kr.access.log;
    error_log  /var/log/nginx/sse.aines.kr.error.log;

    # ---------- Backend API: /api/ → localhost:8080 (경로 그대로 전달) ----------
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ---------- Admin Frontend ----------
    # 방법 1: Next.js를 같은 서버에서 포트 3000으로 실행하는 경우 (proxy)
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 방법 2: Next.js 정적 export 후 Nginx가 직접 서빙하는 경우 (위 location / 블록을 아래로 교체)
    # location / {
    #     alias /var/www/sse-admin/out/;   # next export 후 out/ 또는 정적 빌드 결과 경로
    #     try_files $uri $uri/ /index.html;
    # }
}
