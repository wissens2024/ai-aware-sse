name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend-admin/**'
      - 'packages/**'
      - 'docker-compose.yml'
      - 'initdb/**'
      - '.github/workflows/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)

          # Workflow or shared package changed â†’ deploy both
          if echo "$CHANGED" | grep -qE '^(\.github/workflows/|packages/)'; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if echo "$CHANGED" | grep -qE '^(backend/|docker-compose\.yml|initdb/)'; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
          else
            echo "backend=false" >> "$GITHUB_OUTPUT"
          fi

          if echo "$CHANGED" | grep -qE '^(frontend-admin/|docker-compose\.yml)'; then
            echo "frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "frontend=false" >> "$GITHUB_OUTPUT"
          fi

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            export PATH="$HOME/.local/share/pnpm:$HOME/.npm-global/bin:$PATH"
            cd /home/ju/sase/ai-aware-sse
            git pull origin main
            pnpm install
            cd packages/dlp-core && pnpm run build && cd ../..
            cd backend
            npx prisma generate
            pnpm run build
            pm2 restart sse-backend

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Frontend via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            export PATH="$HOME/.local/share/pnpm:$HOME/.npm-global/bin:$PATH"
            cd /home/ju/sase/ai-aware-sse
            git pull origin main
            pnpm install
            cd frontend-admin
            pnpm run build
            pm2 restart sse-frontend
